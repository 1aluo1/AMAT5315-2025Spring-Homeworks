using Random
abstract type AbstractSemiring <: Number end

# define the -inf
neginf(::Type{T}) where T = typemin(T)
neginf(::Type{T}) where T<:AbstractFloat = typemin(T)
neginf(::Type{T}) where T<:Rational = typemin(T)
neginf(::Type{T}) where T<:Integer = T(-999999)
neginf(::Type{Int16}) = Int16(-16384)
neginf(::Type{Int8}) = Int8(-64)
posinf(::Type{T}) where T = - neginf(T)

struct Tropical{T} <: AbstractSemiring
    n::T
    Tropical{T}(x) where T = new{T}(T(x))
    function Tropical(x::T) where T
        new{T}(x)
    end
    function Tropical{T}(x::Tropical{T}) where T
        x
    end
    function Tropical{T1}(x::Tropical{T2}) where {T1,T2}
        # new is the default constructor
        new{T1}(T2(x.n))
    end
end

# customize the print
Base.show(io::IO, t::Tropical) = Base.print(io, "$(t.n)ₜ")

# power is mapped to multiplication
Base.:^(a::Tropical, b::Real) = Tropical(a.n * b)
Base.:^(a::Tropical, b::Integer) = Tropical(a.n * b)

# multiplication is mapped to addition
Base.:*(a::Tropical, b::Tropical) = Tropical(a.n + b.n)
function Base.:*(a::Tropical{<:Rational}, b::Tropical{<:Rational})
    if a.n.den == 0
        a
    elseif b.n.den == 0
        b
    else
        Tropical(a.n + b.n)
    end
end

# addition is mapped to max
Base.:+(a::Tropical, b::Tropical) = Tropical(max(a.n, b.n))

# minimum value of the semiring
Base.typemin(::Type{Tropical{T}}) where T = Tropical(neginf(T))

# additive identity (zero element) - defined on types
Base.zero(::Type{Tropical{T}}) where T = typemin(Tropical{T})
# additive identity (zero element)
Base.zero(::Tropical{T}) where T = zero(Tropical{T})

# multiplicative identity (one element)
Base.one(::Type{Tropical{T}}) where T = Tropical(zero(T))
Base.one(::Tropical{T}) where T = one(Tropical{T})

# inverse is mapped to negative
Base.inv(x::Tropical) = Tropical(-x.n)

# division is mapped to subtraction
Base.:/(x::Tropical, y::Tropical) = Tropical(x.n - y.n)
# `div` is similar to `/`, the only difference is that `div(::Int, ::Int) -> Int`, but `/(::Int, ::Int) -> Float64`
Base.div(x::Tropical, y::Tropical) = Tropical(x.n - y.n)

# two numbers are approximately equal. For floating point numbers, this is often preferred to `==` due to the rounding error.
Base.isapprox(x::Tropical, y::Tropical; kwargs...) = isapprox(x.n, y.n; kwargs...)

# promotion rules
Base.promote_type(::Type{Tropical{T1}}, b::Type{Tropical{T2}}) where {T1, T2} = Tropical{promote_type(T1,T2)}

function Random.rand(rng::AbstractRNG, ::Random.SamplerType{Tropical{T}}) where T
    Tropical{T}(rand(rng, T))
end



# julia> Tropical(1.0) + Tropical(3.0)
# 3.0ₜ

# julia> Tropical(1.0) * Tropical(3.0)
# 4.0ₜ

# julia> one(Tropical{Float64})
# 0.0ₜ

# julia> zero(Tropical{Float64})
# -Infₜ

# julia> A = rand(Tropical{Float64}, 100, 100)
# 100×100 Matrix{Tropical{Float64}}:
#    0.5961602033802712ₜ     0.556184425362117ₜ    0.41658995014430034ₜ  0.25706234418044926ₜ  …   0.44864615242180794ₜ    0.5212719895387169ₜ   0.7068932882996412ₜ
#    0.4365691291215794ₜ    0.7218416414972006ₜ     0.9812339865542008ₜ   0.7518656997004016ₜ       0.2508954713416074ₜ    0.4772246831025758ₜ    0.676818644496312ₜ
#    0.8932643243831234ₜ  0.026836809588071997ₜ      0.640563542561304ₜ  0.24145816469950343ₜ      0.03066453993506857ₜ   0.06534662775952094ₜ    0.568213224524755ₜ
#    0.5702695224567175ₜ    0.4386053698233481ₜ    0.21578772113766798ₜ   0.4757011427083051ₜ        0.929599298618097ₜ    0.7109360668412076ₜ   0.4264765074535225ₜ
#    0.5061551601664535ₜ    0.5898610965009012ₜ     0.9346736370275358ₜ    0.570314407237597ₜ       0.6987900832164108ₜ   0.12397910037788507ₜ  0.17101927594256006ₜ
#    0.3113321340015138ₜ   0.39023265756927017ₜ     0.6477211736766877ₜ  0.40893996460258186ₜ  …    0.5596826506150212ₜ    0.4153775540345058ₜ   0.1762010191060337ₜ
#   0.34390082414309364ₜ    0.6533128913316216ₜ     0.6002530158289844ₜ   0.5594834204002141ₜ        0.699882365449448ₜ    0.3820461302188095ₜ  0.35351021979220065ₜ
#  0.016064510928793574ₜ    0.8077401925191539ₜ     0.2747310206256125ₜ   0.9213062205517237ₜ       0.7024491379592213ₜ    0.7814176618323494ₜ   0.5677433421769813ₜ
#  0.034336582498682655ₜ   0.11848044793573409ₜ     0.4725604270357817ₜ   0.5669041487682324ₜ       0.5559879165386683ₜ  0.049810233014409344ₜ   0.7889121547952331ₜ
#    0.3386877902262142ₜ    0.7018311524752501ₜ     0.7685900334832299ₜ   0.2995009598768146ₜ       0.9179077725251225ₜ    0.7511116659446586ₜ   0.5001772362813721ₜ
#    0.8939035444728227ₜ    0.7965100258092054ₜ     0.7034996002877336ₜ   0.9691195538154919ₜ  …   0.18114395159231045ₜ     0.857476790136732ₜ  0.16238418413787647ₜ
#    0.5473908663066884ₜ    0.9325903188282929ₜ    0.08216794185507637ₜ   0.6973059528235239ₜ       0.9875052947121818ₜ    0.6590832241012141ₜ  0.21388347525093576ₜ
#   0.41805984831548604ₜ   0.14309712941338626ₜ     0.4194499263796051ₜ   0.3603008072064543ₜ       0.5576929033366399ₜ    0.2985818266286654ₜ   0.6247772201182943ₜ
#    0.9983425762120469ₜ    0.6223027731874088ₜ     0.5916437239216601ₜ  0.03657935086866737ₜ      0.26260343339258974ₜ   0.28523520563927507ₜ  0.43272399998825173ₜ
#                      ⋮                                                                       ⋱                                                
#     0.741990664954533ₜ    0.5773913846738743ₜ    0.16807246284927413ₜ   0.8092756870275337ₜ        0.979875376088151ₜ     0.512454160294551ₜ   0.1744751727442484ₜ
#   0.03494709246397254ₜ   0.39295146951572246ₜ  0.0030006664677055817ₜ   0.8213442251725063ₜ       0.5711037732464198ₜ    0.3258939803422395ₜ   0.6711429684917544ₜ
#    0.6262184231167208ₜ  0.057804083406369555ₜ     0.2011323417940839ₜ   0.7239313739549113ₜ       0.4660555618871596ₜ    0.8172675394778425ₜ    0.467811361277501ₜ
#   0.19225986495534952ₜ     0.828805746732282ₜ     0.5216674608472641ₜ   0.6826882186348542ₜ       0.5607503388057405ₜ  0.027720985968984313ₜ   0.3275157525942415ₜ
#  0.023507436910964796ₜ   0.23049292408556077ₜ     0.9231020574823529ₜ  0.19363492146142935ₜ  …    0.6496631851995156ₜ  0.023384189534351396ₜ   0.4403647067570674ₜ
#   0.10609463191415691ₜ    0.5261053160208058ₜ     0.1598340142519985ₜ  0.06656420826132381ₜ       0.4358389919977288ₜ    0.4657468620275774ₜ   0.5010656061254614ₜ
#     0.959805725895425ₜ   0.10772172599011876ₜ     0.5536255697235472ₜ   0.2922956815373978ₜ      0.13930537439172208ₜ    0.4862362612782022ₜ   0.7579796849832007ₜ
#    0.4241234997201484ₜ   0.12365490747495234ₜ     0.9325093165744514ₜ   0.7426812107156274ₜ       0.8772959622287366ₜ   0.27974324745906076ₜ   0.3890797088265878ₜ
#    0.8468019151527941ₜ    0.2980987561960877ₜ     0.1400341690393273ₜ  0.01610069166405592ₜ       0.9731232974055395ₜ    0.7418957766277633ₜ     0.71470342530541ₜ
#   0.14219718126078285ₜ    0.5252835144310384ₜ     0.9824779021275285ₜ   0.7570414422977847ₜ  …   0.40911629510203407ₜ    0.5643689466044755ₜ   0.5412545355518293ₜ
#    0.4831764553493193ₜ    0.7256738405290211ₜ     0.5688782414564099ₜ   0.9045919520479735ₜ       0.2388482659581861ₜ    0.4578406412153694ₜ   0.2602922594751368ₜ
#    0.2935692551542902ₜ    0.1938296980255173ₜ      0.683920964390789ₜ  0.07022040929568707ₜ     0.006183823946271483ₜ   0.34176456484568074ₜ  0.36883147354682655ₜ
#   0.13084189534044965ₜ      0.67409275299837ₜ     0.6250900024704396ₜ   0.5433924508269178ₜ      0.22438777980546665ₜ   0.29199003083623243ₜ   0.0637642636721859ₜ
#    0.9985165932414816ₜ   0.04486197088496513ₜ   0.061970388190066394ₜ   0.5484098602423003ₜ      0.23829050543830022ₜ  0.056722791346595636ₜ  0.11839477119804043ₜ

# julia> B = rand(Tropical{Float64}, 100, 100)
# 100×100 Matrix{Tropical{Float64}}:
#   0.44267931983166275ₜ   0.9414685665499865ₜ     0.638146782713448ₜ   0.23007974976672485ₜ  …    0.5441787067980229ₜ  0.032132566796796436ₜ    0.6332988261304178ₜ
#    0.5834558579908659ₜ   0.9234346499308702ₜ  0.007833426995437431ₜ    0.6391040120321237ₜ       0.7122885147618201ₜ   0.05782264990893771ₜ    0.1519957861995166ₜ
#    0.5942602293492365ₜ   0.5970956999384978ₜ    0.7530557258705345ₜ    0.6338720712470388ₜ      0.17276173084484525ₜ    0.1067420219401033ₜ    0.6490378557381938ₜ
#   0.26021626431604217ₜ   0.4867844416279381ₜ    0.9749188613012866ₜ    0.7507330113096629ₜ       0.3918713640653414ₜ   0.10195986420238656ₜ  0.007182703695709836ₜ
#    0.7332877188392125ₜ   0.9608037258058661ₜ    0.5658699025623685ₜ   0.05634466080393885ₜ       0.9561789063544254ₜ  0.056903278469319196ₜ    0.7781264220577913ₜ
#   0.32551523994578346ₜ    0.863729461487452ₜ    0.5919633267913456ₜ   0.22734627662756302ₜ  …    0.6503258275626047ₜ   0.09477588678665572ₜ    0.4594908376112449ₜ
#    0.5114170623795172ₜ  0.34868487079609567ₜ   0.46854533757311134ₜ   0.46128609602077086ₜ      0.34263539716192104ₜ     0.719526688748223ₜ   0.04108977411130488ₜ
#   0.49331167465181913ₜ    0.951087078998595ₜ    0.8844967366708473ₜ    0.1816294837361555ₜ       0.9503260560817667ₜ      0.82496108984453ₜ   0.35047600126433764ₜ
#    0.8107542655281975ₜ   0.9183099569292805ₜ      0.74358740288749ₜ  0.056383534005900904ₜ      0.06685520715886895ₜ    0.8111827188634031ₜ    0.5835855834073761ₜ
#   0.05476617698173203ₜ   0.7306875520702995ₜ    0.4336910674226543ₜ    0.3565976989853875ₜ       0.2018514897523228ₜ    0.6748612328018246ₜ    0.2359318275889658ₜ
#    0.6295544140643964ₜ   0.7180630295798788ₜ    0.8074706377629222ₜ    0.9839503004980219ₜ  …    0.4229643069225517ₜ      0.77410116816133ₜ   0.02869348775637126ₜ
#   0.23915813070375058ₜ   0.3232358986998758ₜ   0.08138277037390929ₜ   0.08973680540630435ₜ      0.07186532046761795ₜ    0.9595290114753608ₜ    0.9543704698657685ₜ
#    0.9669917267708295ₜ  0.05380043868587159ₜ    0.1168631751576924ₜ   0.48572507650141994ₜ       0.5721114432236101ₜ    0.4724826793483743ₜ   0.10624210124455125ₜ
#     0.321039864299944ₜ  0.10960950477809428ₜ    0.6786209654897741ₜ    0.2757766069064349ₜ       0.4559101189775401ₜ    0.9118386446238976ₜ    0.5064268934558301ₜ
#                      ⋮                                                                      ⋱                                                
#    0.9616193561966049ₜ   0.1357726017975247ₜ    0.8740557585867114ₜ    0.5392059245489572ₜ       0.7648289981955896ₜ   0.09992225336364069ₜ    0.5678095192908518ₜ
#      0.82697781084493ₜ  0.40250608455958037ₜ   0.18937541163357485ₜ  0.041854363732375166ₜ        0.576199655616083ₜ    0.5746320102465179ₜ   0.18397621829533062ₜ
#  0.045401446302807624ₜ     0.68981568663461ₜ    0.9304934218860926ₜ    0.9316598159151229ₜ     0.029610787595839017ₜ    0.0755613143757099ₜ   0.11265730480471237ₜ
#  0.011089091792345407ₜ  0.13221662457972894ₜ   0.42575662939853054ₜ    0.2523672037082003ₜ       0.7868874513037771ₜ    0.5316791260723257ₜ   0.27603679034906237ₜ
#    0.5685741550430788ₜ   0.9232189582002833ₜ    0.8759700179768876ₜ   0.08068447930484202ₜ  …   0.30936579838433553ₜ   0.13937464658548837ₜ    0.5162944717555319ₜ
#     0.265094139320289ₜ   0.8477266508096835ₜ    0.7473971825227896ₜ    0.4761558780070234ₜ      0.08037906849261733ₜ    0.7156405215664217ₜ    0.5369684406968487ₜ
#    0.3768102100708658ₜ   0.3602641933651878ₜ  0.056194297108802194ₜ   0.14205861564943245ₜ      0.07584407509843238ₜ   0.27163816508640726ₜ   0.47335223943629057ₜ
#    0.3799549969821946ₜ  0.13448900947480658ₜ   0.38383726019303144ₜ    0.9699720247063297ₜ       0.9983851847817772ₜ    0.5990577345462144ₜ    0.4885981774720096ₜ
#    0.7272700548263324ₜ   0.3961669290226255ₜ    0.5341879687883505ₜ    0.9739699579924536ₜ       0.7782524480507236ₜ    0.9475884000761426ₜ    0.9410989116441036ₜ
#    0.8958590934902195ₜ   0.7605947151983633ₜ   0.09479911396305452ₜ    0.8161020706001048ₜ  …    0.7735437189147906ₜ  0.037358811582951956ₜ    0.5282238846400595ₜ
#    0.6186925126746258ₜ  0.11814351863025052ₜ    0.9257788767162219ₜ   0.34187415378783137ₜ       0.2455992134540449ₜ    0.5359531290389904ₜ    0.6108347529132261ₜ
#   0.19278523980686113ₜ   0.9627492833278608ₜ    0.4939352125327744ₜ    0.1417657775090776ₜ       0.5276160167984744ₜ   0.19571644748729833ₜ    0.9013682583347629ₜ
#   0.42917049945017716ₜ   0.4731595941602986ₜ     0.507739637413963ₜ   0.24810813600222215ₜ       0.9648050762030203ₜ    0.8584131181558333ₜ   0.10509805880017709ₜ
#   0.41359869123702075ₜ  0.38676040863373284ₜ    0.7659584891554362ₜ   0.40857315337780786ₜ       0.1981398074301749ₜ     0.730319762642759ₜ    0.8587112145758408ₜ

# julia> C = A * B   # please measure the time taken
# 100×100 Matrix{Tropical{Float64}}:
#  1.9053497160778212ₜ  1.8781240777280095ₜ  1.8767886639054168ₜ  1.8795903050286111ₜ  …  1.9329787403939915ₜ  1.7994339722064625ₜ  1.8323315597366432ₜ
#  1.9011851859500666ₜ  1.7918517867404855ₜ   1.928283718879158ₜ  1.9343341327968222ₜ     1.8494354218765718ₜ  1.8965362380628408ₜ  1.8913776964532483ₜ
#   1.992201312531193ₜ  1.9493647750597594ₜ  1.9126790743166429ₜ    1.90326671121045ₜ     1.7945765915248815ₜ  1.9364963177871743ₜ  1.9134451300837287ₜ
#  1.9131195454801688ₜ  1.8923485819459578ₜ  1.9465777972268858ₜ  1.9243830247746607ₜ      1.859664596028974ₜ  1.9413308893431802ₜ  1.8309675569528598ₜ
#  1.8676994588466926ₜ    1.86961004283136ₜ  1.8423789216972037ₜ   1.972986663606803ₜ     1.8343776600793258ₜ  1.9452734778956415ₜ  1.9253606733647237ₜ
#   1.921248787892801ₜ  1.8183184314898355ₜ  1.9815163471747965ₜ  1.9459201983568297ₜ  …  1.7733260459156934ₜ  1.9198023166882128ₜ  1.9055962088802263ₜ
#  1.8926742492661242ₜ   1.856506570413338ₜ  1.8617444199089097ₜ  1.9390630518349463ₜ     1.9674762119103937ₜ  1.9346226372648667ₜ  1.8371686737138553ₜ
#  1.9425991642325273ₜ  1.8938477550789017ₜ  1.8962250818530104ₜ   1.956662255646059ₜ     1.8930867321620735ₜ   1.951081771332175ₜ  1.9459232297225828ₜ
#  1.8817068296826691ₜ  1.6708760187719465ₜ   1.872511178504832ₜ   1.892127876581692ₜ     1.7043732417857336ₜ  1.8954076575063565ₜ  1.8903881987297488ₜ
#   1.848428969527611ₜ  1.8806570558529834ₜ   1.857313615843733ₜ  1.9698133968626061ₜ     1.7740958869208763ₜ  1.9434318389462952ₜ  1.9369423505142562ₜ
#  1.9468109170828911ₜ   1.953864453652088ₜ  1.9440384151167784ₜ  1.9527465798210681ₜ  …   1.949239634200647ₜ  1.8408951732115324ₜ  1.8762255714786924ₜ
#  1.8493581343882965ₜ  1.9502545780400427ₜ  1.7925204001391317ₜ  1.8855227208857435ₜ      1.924527537198154ₜ  1.8404123834336437ₜ  1.8888735530469447ₜ
#  1.8344264189709132ₜ  1.7277814831157596ₜ  1.9152754078674654ₜ  1.8816822439801908ₜ      1.797549918600534ₜ    1.87004072277956ₜ  1.8462854255916161ₜ
#   1.945470195946049ₜ  1.9398111427620335ₜ  1.8482082538776634ₜ  1.8746968628241454ₜ     1.8875695567968829ₜ   1.848448494716643ₜ  1.6316414023424648ₜ
#                    ⋮                                                                 ⋱                                            
#  1.8174761250315057ₜ   1.942624659416012ₜ   1.808273152102459ₜ  1.8575579746445885ₜ     1.7789643177111063ₜ  1.8033390730986931ₜ  1.8812436344229138ₜ
#  1.9707212232243063ₜ  1.9055095299761442ₜ   1.927560333491984ₜ   1.939521748940276ₜ     1.9509977061576014ₜ  1.8426411937626206ₜ  1.8437611733088264ₜ
#  1.9611481960819324ₜ  1.9097033024426224ₜ  1.9371023668469984ₜ   1.854138055523294ₜ     1.8580641137973564ₜ  1.9501789988820386ₜ  1.9098141127098947ₜ
#  1.8010544561812578ₜ  1.8472656350814463ₜ  1.9413097416373826ₜ  1.8285265590959288ₜ     1.8793194250076093ₜ  1.9381015381321731ₜ  1.9329429965225806ₜ
#  1.9567158968360983ₜ  1.7283693927898316ₜ  1.7130263110014798ₜ   1.843018143826566ₜ  …   1.803437752285119ₜ  1.7483133837826297ₜ  1.8900819552129606ₜ
#  1.8915866560510053ₜ  1.8953581189725281ₜ  1.8070945623522063ₜ  1.8707542811965419ₜ     1.8907332995210873ₜ  1.7739757352970673ₜ   1.900268025098085ₜ
#  1.9055201506453052ₜ  1.9012742924454114ₜ  1.8370716072816968ₜ  1.9239122003163716ₜ     1.8249328183163707ₜ  1.6714030218858151ₜ  1.8766218495359015ₜ
#  1.8565106060188414ₜ  1.9111583999657697ₜ  1.8669195261840157ₜ  1.8962182151642386ₜ     1.8361889149066992ₜ  1.9209547426579152ₜ  1.9157962010483227ₜ
#  1.9585344285094766ₜ  1.9358725807334003ₜ  1.8912790148666159ₜ  1.9470115659516116ₜ     1.9275850737578681ₜ  1.9293841540210277ₜ  1.8744915557403024ₜ
#  1.8819042542972084ₜ  1.8046209550247938ₜ  1.9707206394507777ₜ  1.8958223844993953ₜ  …  1.9111449656927695ₜ  1.8563983356407334ₜ  1.8467505461540783ₜ
#  1.9673927633461858ₜ  1.9177740078986392ₜ  1.8795108133492602ₜ  1.9734785258639835ₜ     1.9560960617036838ₜ  1.9470969679476724ₜ  1.9406074795156334ₜ
#  1.7895376492160162ₜ   1.753863425738186ₜ   1.749843756184129ₜ   1.950423895211975ₜ     1.8282657827360689ₜ   1.827839829632956ₜ  1.9044482425018296ₜ
#  1.8951045786282967ₜ  1.8370563295248008ₜ   1.954493178781181ₜ  1.8935149793847459ₜ     1.8451644312901632ₜ  1.7422419295730667ₜ  1.8382064136721863ₜ
#  1.8339842617064743ₜ  1.9424579646051119ₜ  1.9382424343753222ₜ  1.8920603710293824ₜ     1.9362514193197526ₜ  1.9513190664103623ₜ  1.8453513033996805ₜ